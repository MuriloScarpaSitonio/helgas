{% extends 'store/main.html' %}
{% load static %}
{% load custom_filters %}
{% load crispy_forms_tags %}
{% block content %}


<div class="container-fluid">
	<form method="POST">
		{% csrf_token %}
		<div class="row">
			<div class="col-lg-4">
				<div class="box-element">
					<h3 class="text-center">Resumo do pedido</h3>
					<hr>
					{% for item in items %}
					<div class="row">
						<div class="col-sm-4">
							<a href="{% url 'view_product' item.product.id %}"><img class="row-img"
									src="{{item.product.image_url}}"></a>
						</div>
						<div class="col-sm-8">
							<strong>{{item.product.name}}</strong>
							<h6 class="mb-0 mt-2">Preço: R${{item.product.price|floatformat:2|dot_to_comma}}
							</h6>
							<h6 class="mb-0">Quantidade: {{item.quantity}}</h6>
							<h6 class="mb-0">Total item: R${{item.total|floatformat:2|dot_to_comma}}</h6>
						</div>
					</div>
					<hr>
					{% endfor %}
					<div class="d-flex justify-content-between">
						<a class="btn btn-outline-dark btn-sm" href="{% url 'cart' %}">&#x2190; Voltar ao carrinho</a>
						<h5>Subtotal: <strong>R${{order.cart_total|floatformat:2|dot_to_comma}}</strong>
						</h5>
					</div>
				</div>
			</div>
			<div class="col-lg-4">
				<div class="row">
					<div class="col-xl-12">
						<div class="box-element">
							<h3 class="text-center">Endereço de entrega</h3>
							<hr>
							<div id="user-addresses-form" class="container">
								{% for address in addresses %}
								<label class="mb-2">
									{% if address.main %}
									<input type="radio" id="id_user_addresses_form-addresses_{{address.id}}"
										value="{{address.id}}" name="user_addresses_form-addresses"
										placeholder="{{address}}" checked>
									{% else %}
									<input type="radio" id="id_user_addresses_form-addresses_{{address.id}}"
										value="{{address.id}}" name="user_addresses_form-addresses"
										placeholder="{{address}}">
									{% endif %}
									{{address}}
									<div class="d-flex justify-content-end">
										<a class="btn btn-outline-secondary btn-sm fs-75"
											href="{% url 'view_address' address.id %}">
											Alterar endereço</a>
									</div>
								</label>
								{% endfor %}
							</div>
							<button type="button" id="show-shipping-form-button"
								class="btn btn-outline-dark btn-sm mt-2" onclick="openShippingForm()">
								Cadastrar novo endereço
							</button>
						</div>
					</div>
					<div class="col-lg-12">
						<table class="table table-sm table-striped hidden" id="tableShippingInfos">
							<thead>
								<tr>
									<th scope="col">Serviço</th>
									<th scope="col">Preço</th>
									<th scope="col">Prazo</th>
								</tr>
							</thead>
							<tbody>
								<tr>
									<td>
										<div class="radio">
											<label><input type="radio" id="shipping_services_form-service_04510"
													name="shipping_services_form-service" required="" value="04510">
												PAC
											</label>
										</div>
									</td>
									<td id='price_04510'></td>
									<td id='deadline_04510'></td>
								</tr>
								<tr>
									<td>
										<div class="radio">
											<label><input type="radio" id="shipping_services_form-service_04014"
													name="shipping_services_form-service" required="" value="04014">
												SEDEX
											</label>
										</div>
									</td>
									<td id='price_04014'></td>
									<td id='deadline_04014'></td>
								</tr>
							</tbody>
						</table>
						<div class="d-flex justify-content-start">
							<div id="i-loader-shipping-service" class="spinner-border hidden" role="status">
							</div>
							<small id="shippingInfosLoadingText" class="ml-2 hidden">Obtendo informações de
								envio...</small>
							<strong>
								<p id="shippingInfosError" class="hidden"></p>
							</strong>
						</div>
					</div>
					<div class="col-lg-12 hidden" id="hidden-shipping-form">
						<div class="box-element">
							<h3 class="text-center">Novo endereço</h3>
							<hr>
							{% crispy shipping_form %}
							<div class="d-flex justify-content-start">
								<strong>
									<p id="zipCodeError" class="hidden mt-n4">CEP
										inválido!</p>
								</strong>
								<div id="i-loader" class="spinner-border hidden mt-n4" role="status"></div>
								<small id="zipCodeLoadingText" class="hidden mt-n3 ml-2">Obtendo informações do
									CEP...</small>
							</div>
						</div>
						<div class="d-flex justify-content-end">
							<button onclick="registerNewAddress()" class="btn btn-dark mt-2">Cadastrar novo
								endereço</button>
						</div>
					</div>
				</div>
			</div>
			<div class="col-lg-4">
				<div class="box-element">
					<h3 class="text-center">Forma de pagamento</h3>
					<hr>
					<div class="container" id="accordion"
						data-installments-url="{% url 'load_credit_card_installments' %}">
						<div class="d-flex justify-content-between">
							<div>
								<input type="radio" name="payment_form-payment_type" id="id_payment_form-payment_type_0"
									value="{{payment_form.payment_type_choices.0.0}}" required="" data-toggle="collapse"
									data-target="#collapseInstallments" onclick="ensureCorrectValue()">
								<label>
									<h6>{{payment_form.payment_type_choices.0.1}}</h6>
								</label>
							</div>
							<div class="mt-n1">
								<i class="fab fa-cc-visa fa-2x"></i>
								<i class="fab fa-cc-mastercard fa-2x ml-1"></i>
								<i class="fab fa-cc-amex fa-2x ml-1"></i>
							</div>
						</div>
						<div class="collapse" id="collapseInstallments" data-parent="#accordion">
							{% crispy credit_card_form %}
						</div>
						<div class="d-flex justify-content-between">
							<div>
								<input type="radio" name="payment_form-payment_type" id="id_payment_form-payment_type_1"
									value="{{payment_form.payment_type_choices.1.0}}" required="" data-toggle="collapse"
									data-target="#collapseNonePayPal" onclick="ensureCorrectValue()">
								<label>
									<h6>{{payment_form.payment_type_choices.1.1}}</h6>
								</label>
							</div>
							<div class="mt-n1">
								<i class="fab fa-cc-paypal fa-2x"></i>
							</div>
							<div class="collapse hidden" id="collapseNonePayPal" data-parent="#accordion"></div>
						</div>
						<div class="d-flex justify-content-between">
							<div>
								<input type="radio" name="payment_form-payment_type" id="id_payment_form-payment_type_2"
									value="{{payment_form.payment_type_choices.2.0}}" required="" data-toggle="collapse"
									data-target="#collapseNoneBankSlip" onclick="showDiscontedValue()">
								<label>
									<h6>{{payment_form.payment_type_choices.2.1}} (10% de desconto)</h6>
								</label>
							</div>
							<div>
								<img class="h-100 ml-n38 mt-n1"
									src="https://img.icons8.com/color/48/000000/boleto-bankario.png" />
							</div>
							<div class="collapse hidden" id="collapseNoneBankSlip" data-parent="#accordion">
							</div>
						</div>
						<div id="total" class="d-flex justify-content-end mt-4">
							<div>
								<h4 class="mt-3">
									Total: <strong
										id="total_text">R${{order.cart_total|floatformat:2|dot_to_comma}}</strong>
								</h4>
							</div>
						</div>
						<div id="total-discounted" class="d-flex justify-content-end mt-4 hidden">
							<div>
								<h4 class="mt-3">
									Total:
									<strong
										id="total-discounted_text">R${{order.cash_total|floatformat:2|dot_to_comma}}</strong>
								</h4>
							</div>
						</div>
					</div>
				</div>
				<div class="d-flex justify-content-end">
					<button id="request-order" class="btn btn-success btn-lg mt-2" type="submit">
						Finalizar pedido
					</button>
				</div>
			</div>
		</div>
	</form>
</div>

<div class="d-flex justify-content-end">
	<a class="bank-slip-link" href="https://icons8.com/icon/77599/boleto-bankario" target="_blank"
		rel="noopener noreferrer">
		Boleto Bankario icon by Icons8
	</a>
</div>

<script type="text/javascript" src="{% static 'js/processTotalValueDisplay.js' %}"
	data-cart_total="{{order.cart_total}}" data-cash_total="{{order.cash_total}}"></script>
<script type="text/javascript">

	var zip_code = document.getElementById('id_shipping_form-zip_code')
	var address = document.getElementById('id_shipping_form-address')
	var number = document.getElementById('id_shipping_form-number')
	var neighborhood = document.getElementById('id_shipping_form-neighborhood')
	var complement = document.getElementById('id_shipping_form-complement')
	var reference = document.getElementById('id_shipping_form-reference')
	var city = document.getElementById('id_shipping_form-city')
	var uf = document.getElementById('id_shipping_form-uf')
	var country = document.getElementById('id_shipping_form-country')

	zip_code.disabled = true
	address.disabled = true
	number.disabled = true
	neighborhood.disabled = true
	complement.disabled = true
	reference.disabled = true
	city.disabled = true
	uf.disabled = true
	country.disabled = true

	function openShippingForm() {
		var radios = document.getElementsByName("payment_form-payment_type");
		for (var i = 0; i < radios.length; ++i) {
			radios[i].disabled = true;
		}
		zip_code.disabled = false
		address.disabled = false
		number.disabled = false
		neighborhood.disabled = false
		complement.disabled = false
		reference.disabled = false
		city.disabled = false
		uf.disabled = false
		country.disabled = false

		document.getElementById('show-shipping-form-button').classList.add('hidden')
		document.getElementById('tableShippingInfos').classList.add('hidden')
		document.getElementById('request-order').classList.add('hidden')
		document.getElementById('hidden-shipping-form').classList.remove('hidden')
	}

	function registerNewAddress() {

		var shippingFormData = {
			'zip_code': zip_code.value,
			'address': address.value,
			'number': number.value,
			'neighborhood': neighborhood.value,
			'complement': complement.value,
			'reference': reference.value,
			'city': city.value,
			'uf': uf.value,
			'country': country.value,
		}

		if (
			shippingFormData.zip_code == "" ||
			shippingFormData.address == "" ||
			shippingFormData.number == "" ||
			shippingFormData.neighborhood == "" ||
			shippingFormData.city == "" ||
			shippingFormData.uf == "" ||
			shippingFormData.country == ""
		) {
			return false
		}

		fetch('/register_address_from_checkout/', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
				'X-CSRFToken': csrfToken,
			},
			body: JSON.stringify({ shippingFormData })
		})
			.then((data) => {
				location.reload()
			})
	}
</script>

<script type="module">
	import { getZipCodeInfos, getShippingInfos, getZipCodeError } from "{% static 'js/utils.js' %}"

	if ("{{addresses.count}}" > 0) {
		document.getElementById('tableShippingInfos').classList.remove('hidden')
		processShippingInfosDisplay()
	}


	$("#id_shipping_form-zip_code").keyup(function () {
		if ($(this).val().length == 9) {
			var loader = document.getElementById('i-loader')
			var loading_text = document.getElementById('zipCodeLoadingText')
			var error_text = document.getElementById('zipCodeError')

			loader.classList.remove('hidden')
			loading_text.classList.remove('hidden')
			error_text.classList.add('hidden')

			getZipCodeInfos($(this).val().replace(/\D/g, ''))
				.then((zip_code_infos) => {
					if (zip_code_infos.erro == undefined) {
						loader.classList.add('hidden')
						loading_text.classList.add('hidden')

						document.getElementById("id_shipping_form-address").setAttribute("value", zip_code_infos.logradouro)
						document.getElementById("id_shipping_form-neighborhood").setAttribute("value", zip_code_infos.bairro)
						document.getElementById("id_shipping_form-complement").setAttribute("value", zip_code_infos.complemento)
						document.getElementById("id_shipping_form-city").setAttribute("value", zip_code_infos.localidade)
						var options = document.getElementById("id_shipping_form-uf").options
						for (var i = 0; i < options.length; i++) {
							if (options[i].value == zip_code_infos.uf) {
								options[i].selected = true
							}
						}
						$('#id_shipping_form-uf option:not(:selected)').prop('disabled', true);

						document.getElementById("address-number-row").classList.remove('hidden')
						document.getElementById("complement-reference-row").classList.remove('hidden')
						document.getElementById("neighborhood-city-row").classList.remove('hidden')
						document.getElementById("uf-country-row").classList.remove('hidden')
					}
					else {
						loader.classList.add('hidden')
						loading_text.classList.add('hidden')
						error_text.classList.remove('hidden')
					}
				})
		}
	})

	$('input[type=radio][name=user_addresses_form-addresses]').change(function () {
		processShippingInfosDisplay()
	})

	function processShippingInfosDisplay() {
		var loader = document.getElementById('i-loader-shipping-service')
		var loading_text = document.getElementById('shippingInfosLoadingText')
		var error_text = document.getElementById('shippingInfosError')

		var radio_service_04510 = document.getElementById('shipping_services_form-service_04510')
		var price_text_04510 = document.getElementById('price_04510')
		var deadline_text_04510 = document.getElementById('deadline_04510')

		var radio_service_04014 = document.getElementById('shipping_services_form-service_04014')
		var price_text_04014 = document.getElementById('price_04014')
		var deadline_text_04014 = document.getElementById('deadline_04014')

		loader.classList.remove('hidden')
		loading_text.classList.remove('hidden')
		error_text.classList.add('hidden')

		radio_service_04510.classList.add('hidden')
		price_text_04510.classList.add('hidden')
		deadline_text_04510.classList.add('hidden')

		radio_service_04014.classList.add('hidden')
		price_text_04014.classList.add('hidden')
		deadline_text_04014.classList.add('hidden')

		getShippingInfos(getZipCode())
			.then((shipping_infos) => {
				loader.classList.add('hidden')
				loading_text.classList.add('hidden')

				radio_service_04510.classList.remove('hidden')
				radio_service_04510.checked = false
				price_text_04510.classList.remove('hidden')
				deadline_text_04510.classList.remove('hidden')

				radio_service_04014.classList.remove('hidden')
				radio_service_04014.checked = false
				price_text_04014.classList.remove('hidden')
				deadline_text_04014.classList.remove('hidden')


				if (shipping_infos.PAC.Erro == 0) {
					price_text_04510.innerHTML = 'R$' + shipping_infos.PAC.Valor
					deadline_text_04510.innerHTML = shipping_infos.PAC.PrazoEntrega + ' dias úteis'

					price_text_04014.innerHTML = 'R$' + shipping_infos.SEDEX.Valor
					deadline_text_04014.innerHTML = shipping_infos.SEDEX.PrazoEntrega + ' dias úteis'

				}
				else {
					radio_service_04510.classList.add('hidden')
					radio_service_04014.classList.add('hidden')
					error_text.innerHTML = getZipCodeError(shipping_infos.PAC.Erro, shipping_infos.PAC.MsgErro)
					error_text.classList.remove('hidden')
				}
			})
	}

	function getZipCode() {
		var addresses = document.getElementById('user-addresses-form')
		var radios = addresses.getElementsByTagName('input')
		for (var i = 0; i < radios.length; i++) {
			if (radios[i].checked) {
				var address_infos = radios[i].placeholder.split(' ')
				return address_infos[address_infos.length - 1].split('-').join('')
			}
		}
	}


</script>


{% endblock content %}